<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileVault - Explore File Base</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00c6ff;
            --secondary: #0072ff;
            --accent: #7b4397;
            --dark: #0a0a1a;
            --darker: #050510;
            --light: #f0f4ff;
            --success: #00ff9d;
            --warning: #ffcc00;
            --error: #ff4d4d;
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-hover: rgba(255, 255, 255, 0.15);
            --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 198, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(123, 67, 151, 0.1) 0%, transparent 20%);
            z-index: -1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 10, 30, 0.7);
            padding: 20px 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        /*.header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 198, 255, 0.1), transparent);
            animation: shine 6s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }*/

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px rgba(0, 198, 255, 0.3);
        }

     .admin-btn {
    background: rgba(10, 10, 30, 0.7);  /* Same as header background */
    color: rgba(10, 10, 30, 0.7);  /* Same as background - invisible text */
    border: none;
    padding: 12px 24px;
    border-radius: 50px;
    font-size: 14px;
    font-weight: 600;
    cursor: default;  /* Default cursor */
    transition: var(--transition);
    box-shadow: none;  /* Remove shadow */
    position: relative;
    overflow: hidden;
}

.admin-btn:hover {
    transform: none;  /* Remove hover effect */
    box-shadow: none;  /* Remove hover shadow */
    cursor: pointer;  /* Show pointer on hover */
}

        .admin-btn:active {
            transform: translateY(1px);
        }

        .logout-btn {
            background: linear-gradient(45deg, var(--error), #ff6b6b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(255, 77, 77, 0.3);
        }

        .logout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 77, 77, 0.4);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .title-section {
            background: rgba(20, 20, 40, 0.7);
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .title-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 198, 255, 0.05), transparent);
            animation: shine 8s infinite;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            background: linear-gradient(to right, var(--primary), var(--secondary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 198, 255, 0.2);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .admin-controls {
    background: rgba(20, 20, 40, 0.7);
    padding: 25px;
    border-radius: 16px;
    margin-bottom: 30px;
    display: none;  /* Keep only this display: none */
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    gap: 20px;
    /* ... rest of styles ... */
}

        .admin-controls.active {
            display: flex;
        }

        .admin-controls-left {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .admin-controls-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .storage-info {
            background: rgba(0, 255, 157, 0.15);
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            color: var(--success);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(0, 255, 157, 0.2);
            border: 1px solid rgba(0, 255, 157, 0.2);
        }

        .btn {
            background: linear-gradient(45deg, var(--secondary), var(--accent));
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(123, 67, 151, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(123, 67, 151, 0.4);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #00cc99);
            box-shadow: 0 4px 15px rgba(0, 255, 157, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(0, 255, 157, 0.4);
        }

        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .folder-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
        }

        .folder-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 198, 255, 0.3);
            background: var(--card-hover);
        }

        .folder-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .folder-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, rgba(0, 198, 255, 0.2), rgba(123, 67, 151, 0.2));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .folder-name {
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .folder-count {
            color: rgba(255, 255, 255, 0.7);
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .delete-folder-btn,
        .rename-folder-btn {
            position: absolute;
            top: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }

        .admin-mode .delete-folder-btn,
        .admin-mode .rename-folder-btn {
            display: flex;
        }

        .rename-folder-btn {
            right: 70px;
            background: rgba(30, 100, 255, 0.2);
            color: var(--primary);
        }

        .rename-folder-btn:hover {
            background: rgba(30, 100, 255, 0.3);
            transform: scale(1.1);
        }

        .delete-folder-btn {
            right: 20px;
            background: rgba(255, 77, 77, 0.2);
            color: var(--error);
        }

        .delete-folder-btn:hover {
            background: rgba(255, 77, 77, 0.3);
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 15, 0.9);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(20, 20, 40, 0.95);
            padding: 40px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: rotate(90deg);
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 25px;
            color: white;
            text-align: center;
            font-weight: 700;
        }

        input[type="text"],
        input[type="file"],
        input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            color: white;
            transition: var(--transition);
        }

        input[type="text"]:focus,
        input[type="file"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 198, 255, 0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .files-list {
            margin-top: 30px;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-icon {
            width: 50px;
            height: 50px;
            background: rgba(0, 198, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 198, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .file-size {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            margin-top: 5px;
        }

        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: none;
        }

        .download-progress {
            display: none;
            margin: 15px 0;
        }

        .download-progress.active {
            display: block;
        }

        .download-progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .download-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #00cc99);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .download-progress-text {
            text-align: center;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .upload-progress {
            display: none;
            margin: 25px 0;
        }

        .upload-progress.active {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 8px;
        }

        .upload-status {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            display: none;
        }

        .upload-status.success {
            display: block;
            color: var(--success);
        }

        .upload-status.error {
            display: block;
            color: var(--error);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .breadcrumb span:hover {
            color: var(--primary);
            cursor: pointer;
        }

        .section-title {
            color: var(--light);
            font-size: 24px;
            margin: 25px 0 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .folder-card-inner {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
        }

        .folder-card-inner:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 198, 255, 0.3);
            background: var(--card-hover);
        }

        .folder-card-inner::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .folder-icon-inner {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, rgba(0, 198, 255, 0.2), rgba(123, 67, 151, 0.2));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .folder-name-inner {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
        }

        .folder-count-inner {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        /* Responsive design */
        @media (max-width: 992px) {
            .folders-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }
            
            .admin-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .admin-controls-left, 
            .admin-controls-right {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .modal-content {
                padding: 30px 20px;
            }
            
            .folder-card {
                padding: 20px;
            }
            
            .folder-icon {
                width: 60px;
                height: 60px;
                font-size: 30px;
            }
            
            .folder-name {
                font-size: 18px;
            }
        }

        @media (max-width: 576px) {
            .folders-grid {
                grid-template-columns: 1fr;
            }
            
            .file-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .modal-content {
                padding: 25px 15px;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <i class="fas fa-lock"></i>
            <span>FileVault</span>
        </div>
        <div>
            <button id="adminBtn" class="admin-btn" onclick="toggleAdmin()">
                <i class="fas fa-user-shield"></i> Admin
            </button>
            <button id="logoutBtn" class="logout-btn" onclick="logout()" style="display:none;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <div class="container">
        <div class="title-section">
            <h1>Explore File Base</h1>
            <p class="subtitle">Securely access and organize file materials with our futuristic vault system. Experience seamless file management and unparalleled security.</p>
        </div>

        <div id="adminControls" class="admin-controls">
            <div class="admin-controls-left">
                <span>üåê Admin Controls</span>
                <button class="btn" onclick="showNewFolderModal()">
                    <i class="fas fa-folder-plus"></i> New Folder
                </button>
                <button class="btn btn-success" onclick="showUploadModal()">
                    <i class="fas fa-cloud-upload-alt"></i> Upload File
                </button>
            </div>
            <div class="admin-controls-right">
                <div id="storageInfo" class="storage-info" style="display: none;">
                    <i class="fas fa-database"></i>
                    <span id="storageText">Calculating...</span>
                </div>
            </div>
        </div>

        <div id="foldersGrid" class="folders-grid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <span>Loading folders...</span>
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAdminModal()" title="Close">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title">Admin Access</h2>
            <p style="text-align: center; margin-bottom: 20px; color: rgba(255,255,255,0.7);">Securely access administrative controls</p>
            <input type="password" id="adminPassword" placeholder="Enter admin password">
            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeAdminModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn" onclick="checkAdminPassword()">
                    <i class="fas fa-lock"></i> Login
                </button>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div id="newFolderModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeNewFolderModal()" title="Close">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title">Create New Folder</h2>
            <input type="text" id="folderName" placeholder="Folder name (e.g., untitled)">
            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeNewFolderModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn" onclick="createFolder()">
                    <i class="fas fa-plus"></i> Create
                </button>
            </div>
        </div>
    </div>

    <!-- Upload File Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeUploadModal()" title="Close">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title">Upload File</h2>
            <select id="folderSelect" style="width:100%; padding:15px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.1); border-radius:12px; background:rgba(0,0,0,0.2); color:white;">
                <option value="">Select a folder...</option>
            </select>
            <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.png">
            <div id="uploadProgress" class="upload-progress">
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <div id="progressText" class="progress-text">0%</div>
                <div id="uploadStatus" class="upload-status"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeUploadModal()" id="uploadCancelBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn" onclick="uploadFile()" id="uploadBtn">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeRenameModal()" title="Close">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title" id="renameModalTitle">Rename</h2>
            <input type="text" id="renameInput" placeholder="Enter new name">
            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeRenameModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn" onclick="confirmRename()">
                    <i class="fas fa-save"></i> Rename
                </button>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://tqhvxgemgwyulrswofvr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxaHZ4Z2VtZ3d5dWxyc3dvZnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTM1NTksImV4cCI6MjA3OTcyOTU1OX0.MJM8XRfNfzBM-2ngqVTASCJ3h1CxZ7BKZOCENYYU7W0';
        const BUCKET_NAME = 'notes';
        const ADMIN_PASSWORD = 'admin123'; // Change this to your secure password

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let isAdminMode = false;
        let currentFolders = [];
        let currentFolder = null; // Track which folder is currently being viewed
        let renameContext = { type: null, folder: null, name: null }; // Track what we're renaming

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFolders();
        });

        // Admin Functions
        function toggleAdmin() {
            document.getElementById('adminModal').style.display = 'flex';
        }

        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminMode = true;
                document.getElementById('adminControls').classList.add('active');
                document.getElementById('adminBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.body.classList.add('admin-mode');
                closeAdminModal();
                alert('‚úÖ Admin access granted!');

                // Show storage info
                document.getElementById('storageInfo').style.display = 'flex';
                
                // Reload folders to show admin buttons and calculate storage
                loadFolders();
                calculateTotalStorage();
            } else {
                alert('‚ùå Incorrect password!');
            }
        }

        function logout() {
            isAdminMode = false;
            document.getElementById('adminControls').classList.remove('active');
            document.getElementById('adminBtn').style.display = 'inline-block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.body.classList.remove('admin-mode');
            
            // Hide storage info
            document.getElementById('storageInfo').style.display = 'none';

            // Reload folders to hide all admin buttons
            loadFolders();
        }

        // Load Folders - FIXED
        async function loadFolders() {
            currentFolder = null; // Reset current folder when going back to home
            const grid = document.getElementById('foldersGrid');
            const backBtn = document.getElementById('backToFoldersBtn');
            
            // Show loading animation
            if (backBtn) {
                backBtn.disabled = true;
                backBtn.innerHTML = '<span class="loading-spinner"></span>Loading...';
            }
            grid.innerHTML = '<div class="loading"><span class="loading-spinner"></span>Loading folders...</div>';
            
            try {
                const { data, error } = await supabase.storage
                    .from(BUCKET_NAME)
                    .list('', {
                        limit: 100,
                        offset: 0,
                    });

                if (error) throw error;

                // Get folders - folders have no 'id', files have 'id'
                const folders = {};
                for (const item of data) {
                    if (item.name && !item.id) {
                        folders[item.name] = { folders: 0, files: 0 };
                    }
                }

                // Count folders and files in each folder
                for (const folderName of Object.keys(folders)) {
                    try {
                        const { data: items } = await supabase.storage
                            .from(BUCKET_NAME)
                            .list(folderName, {
                                limit: 100,
                                offset: 0,
                            });
                        if (items) {
                            const subfolders = items.filter(f => !f.id && f.name !== '.placeholder').length;
                            const files = items.filter(f => f.id && f.name !== '.placeholder').length;
                            folders[folderName] = { folders: subfolders, files: files };
                        }
                    } catch (err) {
                        console.error('Error counting items:', err);
                        folders[folderName] = { folders: 0, files: 0 };
                    }
                }

                currentFolders = Object.keys(folders);
                displayFolders(folders);
                updateFolderSelect();
            } catch (error) {
                console.error('Error loading folders:', error);
                document.getElementById('foldersGrid').innerHTML = 
                    '<div class="loading">Error loading folders. Please refresh.</div>';
            } finally {
                const backBtn = document.getElementById('backToFoldersBtn');
                if (backBtn) {
                    backBtn.disabled = false;
                    backBtn.innerHTML = '‚Üê Back to Folders';
                }
            }
        }

        function displayFolders(folders) {
            const grid = document.getElementById('foldersGrid');
            
            if (Object.keys(folders).length === 0) {
                grid.innerHTML = '<div class="loading">No folders yet. Create one to get started!</div>';
                return;
            }

            // Only show top-level folders (those without / in name)
            const topLevelFolders = Object.entries(folders).filter(([name]) => !name.includes('/'));

            if (topLevelFolders.length === 0) {
                grid.innerHTML = '<div class="loading">No folders yet. Create one to get started!</div>';
                return;
            }

            grid.innerHTML = topLevelFolders.map(([name, counts]) => {
                const folderCount = counts.folders || 0;
                const fileCount = counts.files || 0;
                const parts = [];
                if (folderCount > 0) {
                    parts.push(`${folderCount} ${folderCount === 1 ? 'folder' : 'folders'}`);
                }
                if (fileCount > 0) {
                    parts.push(`${fileCount} ${fileCount === 1 ? 'file' : 'files'}`);
                }
                const countText = parts.length > 0 ? parts.join(', ') : 'Empty';
                
                return `
                    <div class="folder-card" onclick="openFolder('${name}')">
                        <button class="rename-folder-btn" onclick="event.stopPropagation(); showRenameFolderModal('${name}')" title="Rename folder">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-folder-btn" onclick="event.stopPropagation(); deleteFolder('${name}')" title="Delete folder">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="folder-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="folder-name">${name}</div>
                        <div class="folder-count">
                            <i class="fas fa-file-alt"></i> ${countText}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateFolderSelect() {
            const select = document.getElementById('folderSelect');
            select.innerHTML = '<option value="">Select a folder...</option>' +
                currentFolders.map(folder => `<option value="${folder}">${folder}</option>`).join('');
        }

        // Create Folder
        function showNewFolderModal() {
            if (!isAdminMode) {
                alert('Admin access required!');
                return;
            }
            document.getElementById('newFolderModal').style.display = 'flex';
        }

        function closeNewFolderModal() {
            document.getElementById('newFolderModal').style.display = 'none';
            document.getElementById('folderName').value = '';
        }

        async function createFolder() {
            const name = document.getElementById('folderName').value.trim();
            if (!name) {
                alert('Please enter a folder name');
                return;
            }

            try {
                // Create folder path - if inside a folder, create nested folder
                const folderPath = currentFolder 
                    ? `${currentFolder}/${name}/.placeholder`
                    : `${name}/.placeholder`;
                
                // Create a placeholder file to create the folder
                const placeholder = new Blob([''], { type: 'text/plain' });
                const { error } = await supabase.storage
                    .from(BUCKET_NAME)
                    .upload(folderPath, placeholder);

                if (error) throw error;

                alert('‚úÖ Folder created successfully!');
                closeNewFolderModal();
                
                // Reload current view
                if (currentFolder) {
                    await openFolder(currentFolder);
                } else {
                    loadFolders();
                }
            } catch (error) {
                console.error('Error creating folder:', error);
                alert('‚ùå Error creating folder. Please try again.');
            }
        }

        // Upload File
        function showUploadModal() {
            if (!isAdminMode) {
                alert('Admin access required!');
                return;
            }
            
            const folderSelect = document.getElementById('folderSelect');
            const folderSelectContainer = folderSelect.parentElement;
            
            // If viewing a folder, pre-select it and hide the dropdown
            if (currentFolder) {
                folderSelect.value = currentFolder;
                folderSelect.setAttribute('data-current-folder', currentFolder); // Store in data attribute as backup
                folderSelect.style.display = 'none';
                // Show the selected folder name as text
                let folderLabel = folderSelectContainer.querySelector('.selected-folder-label');
                if (!folderLabel) {
                    folderLabel = document.createElement('div');
                    folderLabel.className = 'selected-folder-label';
                    folderLabel.style.cssText = 'padding: 15px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(0,0,0,0.2); color: white; font-size: 16px; text-align: center;';
                    folderSelectContainer.insertBefore(folderLabel, folderSelect);
                }
                folderLabel.textContent = `üìÅ Uploading to: ${currentFolder}`;
            } else {
                // On home page, show dropdown normally
                folderSelect.style.display = 'block';
                folderSelect.value = '';
                folderSelect.removeAttribute('data-current-folder');
                const folderLabel = folderSelect.parentElement.querySelector('.selected-folder-label');
                if (folderLabel) {
                    folderLabel.remove();
                }
            }
            
            document.getElementById('uploadModal').style.display = 'flex';
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            document.getElementById('fileInput').value = '';
            const folderSelect = document.getElementById('folderSelect');
            folderSelect.value = '';
            folderSelect.style.display = 'block'; // Reset to show dropdown
            const folderLabel = folderSelect.parentElement.querySelector('.selected-folder-label');
            if (folderLabel) {
                folderLabel.remove();
            }
            // Reset progress
            document.getElementById('uploadProgress').classList.remove('active');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            document.getElementById('uploadStatus').classList.remove('success', 'error');
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('uploadCancelBtn').disabled = false;
        }

        async function uploadFile() {
            const folderSelect = document.getElementById('folderSelect');
            let folder = folderSelect.value;
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            // If no folder selected, try to get from data attribute or currentFolder
            if (!folder) {
                folder = folderSelect.getAttribute('data-current-folder') || currentFolder;
            }

            if (!folder || !file) {
                alert('Please select a folder and a file');
                return;
            }

            // Ensure folder path doesn't have leading/trailing slashes
            folder = folder.trim().replace(/^\/+|\/+$/g, '');

            // Show progress bar
            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadBtn = document.getElementById('uploadBtn');
            const cancelBtn = document.getElementById('uploadCancelBtn');

            progressContainer.classList.add('active');
            uploadStatus.classList.remove('success', 'error');
            uploadStatus.textContent = '';
            uploadBtn.disabled = true;
            cancelBtn.disabled = true;

            // Simulate progress animation
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                }
            }, 200);

            try {
                // Construct file path - ensure proper format for nested folders
                const filePath = folder ? `${folder}/${file.name}` : file.name;
                console.log('Uploading to path:', filePath); // Debug log
                
                const { error } = await supabase.storage
                    .from(BUCKET_NAME)
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                clearInterval(progressInterval);

                if (error) throw error;

                // Complete progress
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                
                // Show success message
                setTimeout(() => {
                    uploadStatus.classList.add('success');
                    uploadStatus.textContent = '‚úÖ Upload Complete!';
                    
                    // Close modal and reload after 1.5 seconds
                    setTimeout(() => {
                        closeUploadModal();
                        // If viewing a folder, refresh that folder; otherwise reload folders
                        if (currentFolder) {
                            openFolder(currentFolder);
                        } else {
                            loadFolders();
                        }
                        // Recalculate storage after upload
                        if (isAdminMode) {
                            calculateTotalStorage();
                        }
                    }, 1500);
                }, 500);

            } catch (error) {
                clearInterval(progressInterval);
                console.error('Error uploading file:', error);
                
                uploadStatus.classList.add('error');
                uploadStatus.textContent = '‚ùå Upload Failed: ' + (error.message || 'File might already exist');
                uploadBtn.disabled = false;
                cancelBtn.disabled = false;
            }
        }

        // Open Folder
        async function openFolder(folderName) {
            currentFolder = folderName; // Set current folder
            const grid = document.getElementById('foldersGrid');
            
            // Show loading animation
            grid.innerHTML = '<div class="loading"><span class="loading-spinner"></span>Loading folder...</div>';
            
            try {
                const { data, error } = await supabase.storage
                    .from(BUCKET_NAME)
                    .list(folderName, {
                        limit: 100,
                        offset: 0,
                    });

                if (error) throw error;

                // Separate folders and files
                const folders = data.filter(item => !item.id && item.name !== '.placeholder');
                const files = data.filter(item => item.id);

                await displayFolderContents(folderName, folders, files);
            } catch (error) {
                console.error('Error loading folder:', error);
                grid.innerHTML = '<div class="loading">Error loading folder. Please try again.</div>';
                alert('Error loading folder');
            }
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 MB';
            const mb = bytes / (1024 * 1024);
            return mb.toFixed(2) + ' MB';
        }

        // Calculate total storage used
        async function calculateTotalStorage() {
            const storageText = document.getElementById('storageText');
            if (!storageText) return;
            
            storageText.textContent = 'Calculating...';
            
            try {
                let totalSize = 0;
                
                // Recursively get all files from all folders
                async function getAllFiles(path = '') {
                    const { data, error } = await supabase.storage
                        .from(BUCKET_NAME)
                        .list(path, {
                            limit: 1000,
                            offset: 0,
                        });
                    
                    if (error) throw error;
                    if (!data) return;
                    
                    for (const item of data) {
                        if (item.id) {
                            // It's a file - get its size
                            try {
                                const filePath = path ? `${path}/${item.name}` : item.name;
                                const { data: fileData } = await supabase.storage
                                    .from(BUCKET_NAME)
                                    .download(filePath);
                                if (fileData) {
                                    totalSize += fileData.size;
                                }
                            } catch (err) {
                                // Skip files we can't access
                                console.warn('Could not get size for:', item.name);
                            }
                        } else if (item.name !== '.placeholder') {
                            // It's a folder - recurse
                            const folderPath = path ? `${path}/${item.name}` : item.name;
                            await getAllFiles(folderPath);
                        }
                    }
                }
                
                await getAllFiles();
                
                // Update display
                const totalMB = totalSize / (1024 * 1024);
                storageText.textContent = `${totalMB.toFixed(2)} MB Total`;
            } catch (error) {
                console.error('Error calculating storage:', error);
                storageText.textContent = 'Error calculating storage';
            }
        }

        async function displayFolderContents(folderName, folders, files) {
            const grid = document.getElementById('foldersGrid');
            
            // Get file sizes - fetch file info to get size
            const filesWithSizes = await Promise.all(files.map(async (file) => {
                try {
                    // Get file info which includes size
                    const { data: fileData } = await supabase.storage
                        .from(BUCKET_NAME)
                        .download(`${folderName}/${file.name}`);
                    return { 
                        ...file, 
                        displaySize: fileData ? fileData.size : 0 
                    };
                } catch (error) {
                    // If we can't get size, default to 0
                    return { ...file, displaySize: 0 };
                }
            }));

            // Count folders and files in each subfolder
            const foldersWithCounts = await Promise.all(folders.map(async (folder) => {
                try {
                    const { data: items } = await supabase.storage
                        .from(BUCKET_NAME)
                        .list(`${folderName}/${folder.name}`, {
                            limit: 100,
                            offset: 0,
                        });
                    const subfolders = items ? items.filter(f => !f.id && f.name !== '.placeholder').length : 0;
                    const files = items ? items.filter(f => f.id && f.name !== '.placeholder').length : 0;
                    return { ...folder, folders: subfolders, files: files };
                } catch (error) {
                    return { ...folder, folders: 0, files: 0 };
                }
            }));

            // Build folders HTML
            const foldersHTML = foldersWithCounts.map(folder => {
                const fullPath = `${folderName}/${folder.name}`;
                const folderCount = folder.folders || 0;
                const fileCount = folder.files || 0;
                const parts = [];
                if (folderCount > 0) {
                    parts.push(`${folderCount} ${folderCount === 1 ? 'folder' : 'folders'}`);
                }
                if (fileCount > 0) {
                    parts.push(`${fileCount} ${fileCount === 1 ? 'file' : 'files'}`);
                }
                const countText = parts.length > 0 ? parts.join(', ') : 'Empty';
                
                return `
                    <div class="folder-card" onclick="openFolder('${fullPath}')">
                        <button class="rename-folder-btn" onclick="event.stopPropagation(); showRenameFolderModal('${fullPath}')" title="Rename folder">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-folder-btn" onclick="event.stopPropagation(); deleteFolder('${fullPath}')" title="Delete folder">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="folder-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="folder-name">${folder.name}</div>
                        <div class="folder-count">
                            <i class="fas fa-file-alt"></i> ${countText}
                        </div>
                    </div>
                `;
            }).join('');

            // Build files HTML
            const filesHTML = filesWithSizes.map(file => {
                const fileExt = file.name.split('.').pop().toLowerCase();
                const icon = getFileIcon(fileExt);
                const fileSize = formatFileSize(file.displaySize || 0);
                const fileId = file.name.replace(/[^a-zA-Z0-9]/g, '_');
                
                return `
                    <div class="file-item" id="file-item-${fileId}">
                        <div class="file-info">
                            <div class="file-icon">${icon}</div>
                            <div>
                                <div>${file.name}</div>
                                <div class="file-size">${fileSize}</div>
                            </div>
                        </div>
                        <div class="file-actions">
                            ${!isAdminMode ? `<button class="btn btn-small view-btn" style="background:#00ff9d" onclick="viewFile('${folderName}', '${file.name}')" id="view-btn-${fileId}">üëÅÔ∏è View</button>` : ''}
                            <button class="btn btn-small download-btn" onclick="downloadFile('${folderName}', '${file.name}')" id="download-btn-${fileId}">‚¨áÔ∏è Download</button>
                            ${isAdminMode ? `<button class="btn btn-small rename-file-btn" style="background:#00c6ff" onclick="showRenameFileModal('${folderName}', '${file.name}')" id="rename-btn-${fileId}">‚úèÔ∏è Rename</button>` : ''}
                            ${isAdminMode ? `<button class="btn btn-small delete-file-btn" style="background:#ff4d4d" onclick="deleteFile('${folderName}', '${file.name}')" id="delete-btn-${fileId}">üóëÔ∏è Delete</button>` : ''}
                        </div>
                        <div class="download-progress" id="download-progress-${fileId}">
                            <div class="download-progress-bar-container">
                                <div class="download-progress-bar" id="download-bar-${fileId}"></div>
                            </div>
                            <div class="download-progress-text" id="download-text-${fileId}">0%</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Build breadcrumb navigation
            const pathParts = folderName.split('/');
            const breadcrumbs = pathParts.map((part, index) => {
                const pathToPart = pathParts.slice(0, index + 1).join('/');
                return `<span onclick="openFolder('${pathToPart}')" style="cursor: pointer; color: var(--primary);">${part}</span>`;
            }).join(' / ');

            // Determine back button action
            const parentPath = pathParts.slice(0, -1).join('/');
            const backAction = parentPath ? `openFolder('${parentPath}')` : 'loadFolders()';
            const backText = parentPath ? '‚Üê Back' : '‚Üê Back to Folders';

            if (folders.length === 0 && files.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1;">
                        <button class="btn" id="backToFoldersBtn" onclick="${backAction}">${backText}</button>
                        <div class="breadcrumb">${breadcrumbs}</div>
                        <h2 class="section-title">üìÅ ${pathParts[pathParts.length - 1]}</h2>
                        <div class="loading">No folders or files in this folder yet.</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = `
                <div style="grid-column: 1/-1;">
                    <button class="btn" id="backToFoldersBtn" onclick="${backAction}">${backText}</button>
                    <div class="breadcrumb">${breadcrumbs}</div>
                    <h2 class="section-title">üìÅ ${pathParts[pathParts.length - 1]}</h2>
                    ${folders.length > 0 ? `<div class="folder-grid">${foldersHTML}</div>` : ''}
                    ${files.length > 0 ? `<div class="files-list">${filesHTML}</div>` : ''}
                </div>
            `;
        }

        function getFileIcon(ext) {
            const icons = {
                pdf: 'üìÑ',
                doc: 'üìù',
                docx: 'üìù',
                ppt: 'üìä',
                pptx: 'üìä',
                txt: 'üìÉ',
                jpg: 'üñºÔ∏è',
                jpeg: 'üñºÔ∏è',
                png: 'üñºÔ∏è'
            };
            return icons[ext] || 'üìé';
        }

        // View File - Open file in new tab
        async function viewFile(folder, fileName) {
            const fileId = fileName.replace(/[^a-zA-Z0-9]/g, '_');
            const viewBtn = document.getElementById(`view-btn-${fileId}`);
            
            // Show loading state
            if (viewBtn) {
                viewBtn.classList.add('btn-loading');
                viewBtn.innerHTML = '<span class="loading-spinner"></span>Opening...';
            }
            
            try {
                const filePath = folder ? `${folder}/${fileName}` : fileName;
                
                // Try to get public URL from Supabase (if bucket is public)
                const { data: publicUrlData } = supabase.storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(filePath);

                if (publicUrlData && publicUrlData.publicUrl) {
                    // Open public URL in new tab
                    window.open(publicUrlData.publicUrl, '_blank');
                    if (viewBtn) {
                        viewBtn.classList.remove('btn-loading');
                        viewBtn.innerHTML = 'üëÅÔ∏è View';
                    }
                } else {
                    // Fallback: download file and create blob URL
                    const { data: fileData, error } = await supabase.storage
                        .from(BUCKET_NAME)
                        .download(filePath);

                    if (error) throw error;

                    // Create blob URL and open in new tab
                    const url = URL.createObjectURL(fileData);
                    window.open(url, '_blank');
                    
                    // Clean up after a delay
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                        if (viewBtn) {
                            viewBtn.classList.remove('btn-loading');
                            viewBtn.innerHTML = 'üëÅÔ∏è View';
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Error viewing file:', error);
                if (viewBtn) {
                    viewBtn.classList.remove('btn-loading');
                    viewBtn.innerHTML = 'üëÅÔ∏è View';
                }
                alert('Error opening file: ' + (error.message || 'Unknown error'));
            }
        }

        // Download File - FIXED to preserve correct file type
        async function downloadFile(folder, fileName) {
            const fileId = fileName.replace(/[^a-zA-Z0-9]/g, '_');
            const downloadBtn = document.getElementById(`download-btn-${fileId}`);
            const progressContainer = document.getElementById(`download-progress-${fileId}`);
            const progressBar = document.getElementById(`download-bar-${fileId}`);
            const progressText = document.getElementById(`download-text-${fileId}`);

            // Show loading state
            if (downloadBtn) {
                downloadBtn.classList.add('btn-loading');
                downloadBtn.innerHTML = '<span class="loading-spinner"></span>Downloading...';
            }
            if (progressContainer) {
                progressContainer.classList.add('active');
            }

            // Simulate download progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    if (progressBar) progressBar.style.width = progress + '%';
                    if (progressText) progressText.textContent = Math.round(progress) + '%';
                }
            }, 200);

            try {
                const { data, error } = await supabase.storage
                    .from(BUCKET_NAME)
                    .download(`${folder}/${fileName}`);

                clearInterval(progressInterval);

                if (error) throw error;

                // Complete progress
                if (progressBar) progressBar.style.width = '100%';
                if (progressText) progressText.textContent = '100%';

                // Create download link with proper blob
                const url = URL.createObjectURL(data);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // Clean up
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                    if (progressContainer) {
                        progressContainer.classList.remove('active');
                        if (progressBar) progressBar.style.width = '0%';
                        if (progressText) progressText.textContent = '0%';
                    }
                    if (downloadBtn) {
                        downloadBtn.classList.remove('btn-loading');
                        downloadBtn.innerHTML = '‚¨áÔ∏è Download';
                    }
                }, 1000);
            } catch (error) {
                clearInterval(progressInterval);
                console.error('Error downloading file:', error);
                if (progressContainer) progressContainer.classList.remove('active');
                if (downloadBtn) {
                    downloadBtn.classList.remove('btn-loading');
                    downloadBtn.innerHTML = '‚¨áÔ∏è Download';
                }
                alert('Error downloading file: ' + error.message);
            }
        }

        // Delete File
        async function deleteFile(folder, fileName) {
            if (!isAdminMode) return;
            
            if (!confirm(`Are you sure you want to delete ${fileName}?`)) return;

            const fileId = fileName.replace(/[^a-zA-Z0-9]/g, '_');
            const deleteBtn = document.getElementById(`delete-btn-${fileId}`);
            
            // Show loading state
            if (deleteBtn) {
                deleteBtn.classList.add('btn-loading');
                deleteBtn.innerHTML = '<span class="loading-spinner"></span>Deleting...';
            }

            try {
                const { error } = await supabase.storage
                    .from(BUCKET_NAME)
                    .remove([`${folder}/${fileName}`]);

                if (error) throw error;

                alert('‚úÖ File deleted successfully!');
                await openFolder(folder);
                // Recalculate storage after deletion
                if (isAdminMode) {
                    calculateTotalStorage();
                }
            } catch (error) {
                console.error('Error deleting file:', error);
                if (deleteBtn) {
                    deleteBtn.classList.remove('btn-loading');
                    deleteBtn.innerHTML = 'üóëÔ∏è Delete';
                }
                alert('‚ùå Error deleting file');
            }
        }

        // Delete Folder
        async function deleteFolder(folderPath) {
            if (!isAdminMode) return;
            
            const folderName = folderPath.split('/').pop();
            if (!confirm(`Are you sure you want to delete the entire "${folderName}" folder?`)) return;

            const grid = document.getElementById('foldersGrid');
            grid.innerHTML = '<div class="loading"><span class="loading-spinner"></span>Deleting folder...</div>';

            try {
                // Get all files in folder (recursively)
                const allFiles = [];
                async function getAllFiles(path) {
                    const { data, error } = await supabase.storage
                        .from(BUCKET_NAME)
                        .list(path);
                    if (error) throw error;
                    
                    for (const item of data) {
                        if (item.id) {
                            // It's a file
                            allFiles.push(`${path}/${item.name}`);
                        } else if (item.name !== '.placeholder') {
                            // It's a subfolder, recurse
                            await getAllFiles(`${path}/${item.name}`);
                        }
                    }
                }
                
                await getAllFiles(folderPath);

                // Delete all files
                if (allFiles.length > 0) {
                    const { error: deleteError } = await supabase.storage
                        .from(BUCKET_NAME)
                        .remove(allFiles);

                    if (deleteError) throw deleteError;
                }

                alert('‚úÖ Folder deleted successfully!');
                
                // Navigate back to parent or root
                const pathParts = folderPath.split('/');
                const parentPath = pathParts.slice(0, -1).join('/');
                
                if (currentFolder && currentFolder.startsWith(folderPath)) {
                    // If we're inside the deleted folder, go to parent
                    if (parentPath) {
                        await openFolder(parentPath);
                    } else {
                        loadFolders();
                    }
                } else if (parentPath) {
                    await openFolder(parentPath);
                } else {
                    loadFolders();
                }
                
                // Recalculate storage after deletion
                if (isAdminMode) {
                    calculateTotalStorage();
                }
            } catch (error) {
                console.error('Error deleting folder:', error);
                alert('‚ùå Error deleting folder');
            }
        }

        // Rename Functions
        function showRenameFolderModal(folderPath) {
            if (!isAdminMode) return;
            // Extract just the folder name (last part of path)
            const folderName = folderPath.split('/').pop();
            renameContext = { type: 'folder', folder: null, name: folderPath };
            document.getElementById('renameModalTitle').textContent = 'Rename Folder';
            document.getElementById('renameInput').value = folderName;
            document.getElementById('renameInput').placeholder = 'Enter new folder name';
            document.getElementById('renameModal').style.display = 'flex';
        }

        function showRenameFileModal(folderName, fileName) {
            if (!isAdminMode) return;
            renameContext = { type: 'file', folder: folderName, name: fileName };
            document.getElementById('renameModalTitle').textContent = 'Rename File';
            // Show filename without extension for editing
            const nameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
            document.getElementById('renameInput').value = nameWithoutExt;
            document.getElementById('renameInput').placeholder = 'Enter new file name';
            document.getElementById('renameModal').style.display = 'flex';
            
            // Get the rename button for this file and show loading if needed
            const fileId = fileName.replace(/[^a-zA-Z0-9]/g, '_');
            const renameBtn = document.getElementById(`rename-btn-${fileId}`);
            if (renameBtn) {
                renameBtn.classList.add('btn-loading');
                renameBtn.innerHTML = '<span class="loading-spinner"></span>Opening...';
                setTimeout(() => {
                    if (renameBtn) {
                        renameBtn.classList.remove('btn-loading');
                        renameBtn.innerHTML = '‚úèÔ∏è Rename';
                    }
                }, 500);
            }
        }

        function closeRenameModal() {
            document.getElementById('renameModal').style.display = 'none';
            document.getElementById('renameInput').value = '';
            renameContext = { type: null, folder: null, name: null };
        }

        async function confirmRename() {
            if (!isAdminMode) return;

            const newName = document.getElementById('renameInput').value.trim();
            if (!newName) {
                alert('Please enter a name');
                return;
            }

            const renameBtn = document.querySelector('#renameModal .modal-buttons .btn:last-child');
            const originalText = renameBtn ? renameBtn.innerHTML : 'Rename';
            
            // Show loading state
            if (renameBtn) {
                renameBtn.disabled = true;
                renameBtn.classList.add('btn-loading');
                renameBtn.innerHTML = '<span class="loading-spinner"></span>Renaming...';
            }

            try {
                if (renameContext.type === 'folder') {
                    await renameFolder(renameContext.name, newName);
                } else if (renameContext.type === 'file') {
                    await renameFile(renameContext.folder, renameContext.name, newName);
                }
                closeRenameModal();
            } catch (error) {
                if (renameBtn) {
                    renameBtn.disabled = false;
                    renameBtn.classList.remove('btn-loading');
                    renameBtn.innerHTML = originalText;
                }
            }
        }

        async function renameFolder(oldFullPath, newName) {
            // Handle nested paths - extract parent path and folder name
            const pathParts = oldFullPath.split('/');
            const oldFolderName = pathParts[pathParts.length - 1];
            const parentPath = pathParts.slice(0, -1).join('/');
            const newFullPath = parentPath ? `${parentPath}/${newName}` : newName;

            if (oldFullPath === newFullPath) {
                closeRenameModal();
                return;
            }

            // Check if new folder name already exists in parent
            const checkPath = parentPath || '';
            const { data: existing } = await supabase.storage
                .from(BUCKET_NAME)
                .list(checkPath, { limit: 100 });
            
            if (existing && existing.some(item => item.name === newName && !item.id)) {
                alert('‚ùå A folder with this name already exists!');
                throw new Error('Folder name exists');
            }

            try {
                // Get all files in the old folder
                const { data: files, error: listError } = await supabase.storage
                    .from(BUCKET_NAME)
                    .list(oldFullPath);

                if (listError) throw listError;

                // Create new folder with placeholder
                const placeholder = new Blob([''], { type: 'text/plain' });
                await supabase.storage
                    .from(BUCKET_NAME)
                    .upload(`${newFullPath}/.placeholder`, placeholder);

                // Copy all files to new folder
                for (const file of files) {
                    if (file.name === '.placeholder') continue;
                    
                    // Download file from old location
                    const { data: fileData, error: downloadError } = await supabase.storage
                        .from(BUCKET_NAME)
                        .download(`${oldFullPath}/${file.name}`);

                    if (downloadError) throw downloadError;

                    // Upload to new location
                    const { error: uploadError } = await supabase.storage
                        .from(BUCKET_NAME)
                        .upload(`${newFullPath}/${file.name}`, fileData, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (uploadError) throw uploadError;
                }

                // Delete old folder (all files)
                const filesToDelete = files.map(file => `${oldFullPath}/${file.name}`);
                const { error: deleteError } = await supabase.storage
                    .from(BUCKET_NAME)
                    .remove(filesToDelete);

                if (deleteError) throw deleteError;

                alert('‚úÖ Folder renamed successfully!');
                
                // Reload current view
                if (currentFolder && currentFolder.startsWith(oldFullPath)) {
                    // If we're inside the renamed folder, navigate to new path
                    const newCurrentPath = currentFolder.replace(oldFullPath, newFullPath);
                    await openFolder(newCurrentPath);
                } else if (parentPath) {
                    // If we're in a parent folder, reload it
                    await openFolder(parentPath);
                } else {
                    loadFolders();
                }
            } catch (error) {
                console.error('Error renaming folder:', error);
                alert('‚ùå Error renaming folder: ' + (error.message || 'Unknown error'));
            }
        }

        async function renameFile(folderName, oldFileName, newName) {
            // Get file extension
            const fileExt = oldFileName.substring(oldFileName.lastIndexOf('.')) || '';
            const newFileName = newName + fileExt;

            if (oldFileName === newFileName) {
                closeRenameModal();
                return;
            }

            const fileId = oldFileName.replace(/[^a-zA-Z0-9]/g, '_');
            const renameBtn = document.getElementById(`rename-btn-${fileId}`);

            // Show loading state on button
            if (renameBtn) {
                renameBtn.classList.add('btn-loading');
                renameBtn.innerHTML = '<span class="loading-spinner"></span>Renaming...';
            }

            try {
                // Download the file
                const { data: fileData, error: downloadError } = await supabase.storage
                    .from(BUCKET_NAME)
                    .download(`${folderName}/${oldFileName}`);

                if (downloadError) throw downloadError;

                // Upload with new name
                const { error: uploadError } = await supabase.storage
                    .from(BUCKET_NAME)
                    .upload(`${folderName}/${newFileName}`, fileData, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) {
                    if (uploadError.message.includes('already exists')) {
                        alert('‚ùå A file with this name already exists!');
                    } else {
                        throw uploadError;
                    }
                    if (renameBtn) {
                        renameBtn.classList.remove('btn-loading');
                        renameBtn.innerHTML = '‚úèÔ∏è Rename';
                    }
                    return;
                }

                // Delete old file
                const { error: deleteError } = await supabase.storage
                    .from(BUCKET_NAME)
                    .remove([`${folderName}/${oldFileName}`]);

                if (deleteError) throw deleteError;

                alert('‚úÖ File renamed successfully!');
                await openFolder(folderName);
            } catch (error) {
                console.error('Error renaming file:', error);
                if (renameBtn) {
                    renameBtn.classList.remove('btn-loading');
                    renameBtn.innerHTML = '‚úèÔ∏è Rename';
                }
                alert('‚ùå Error renaming file: ' + (error.message || 'Unknown error'));
                throw error; // Re-throw to be caught by confirmRename
            }
        }
    </script>
</body>
</html>
